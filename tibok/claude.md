# Claude Code Instructions for Tibok Development

This file contains project-specific instructions for Claude Code when working on the Tibok markdown editor project.

## Project Context

Tibok is a native macOS markdown editor built with Swift and SwiftUI. Key features:
- Workspace management with file browser
- Git integration (commit, push, branches, history, diffs)
- Real-time markdown preview
- Keyboard-first design with comprehensive shortcuts
- Mac App Store distribution

## Critical Build & Release Workflows

### Development Build

```bash
# Build and run locally
./scripts/build-app.sh
open .build/debug/tibok.app
```

### App Store Distribution (via Xcode Cloud)

For Mac App Store releases, use the Xcode Cloud automated workflow:

```bash
# 1. Update version in Info.plist
# 2. Commit changes
git add tibok/Resources/Info-AppStore.plist
git commit -m "Bump version to X.Y.Z"
git push origin main

# 3. Trigger Xcode Cloud build
git checkout apple-store-distro
git pull origin apple-store-distro
git merge main
git push origin apple-store-distro

# Xcode Cloud will automatically:
# - Build the app
# - Sign with Mac App Store certificate
# - Upload to TestFlight
# - Notify when complete
```

Monitor builds at: https://appstoreconnect.apple.com → Xcode Cloud → Builds

### GitHub Release Distribution (Direct Download DMG)

**CRITICAL**: For DMG files distributed outside the Mac App Store (e.g., GitHub releases), you MUST complete the full notarization workflow. Skipping notarization causes Gatekeeper to block the app with a "malware" warning.

#### Complete Notarization Workflow (DO NOT SKIP STEPS)

```bash
# 1. Build and sign the app bundle
./scripts/build-release-dmg.sh F2PFRMGC9V <version>

# 2. Create DMG from signed app
./scripts/create-dmg.sh <version>

# 3. Notarize with Apple (THIS STEP IS CRITICAL)
xcrun notarytool submit .build/release/Tibok-<version>.dmg \
  --keychain-profile "TIBOK_NOTARIZATION" \
  --wait

# 4. Staple notarization ticket to DMG
xcrun stapler staple .build/release/Tibok-<version>.dmg

# 5. Verify notarization
xcrun stapler validate .build/release/Tibok-<version>.dmg

# 6. Upload to GitHub release
gh release upload v<version> .build/release/Tibok-<version>.dmg
```

#### Why Each Step Matters

1. **Build & Sign**: Code signs app with Developer ID certificate (required for notarization)
2. **Create DMG**: Packages signed app into distributable disk image
3. **Notarize**: Apple scans and approves the app, generates notarization ticket
4. **Staple**: Attaches notarization ticket to DMG so it works offline
5. **Verify**: Confirms notarization process completed successfully
6. **Upload**: Distributes notarized DMG to users

#### What Happens If You Skip Notarization?

macOS Gatekeeper will show this error when users try to open the app:

```
"Apple could not verify 'tibok' is free of malware that may harm your Mac
or compromise your privacy."
```

The app will be completely blocked and won't run. Users will need to:
- Right-click → Open (override Gatekeeper)
- Go to System Settings → Privacy & Security → Allow anyway

This creates a terrible user experience. **Always notarize.**

#### Notarization Troubleshooting

Check notarization history:
```bash
xcrun notarytool history --keychain-profile "TIBOK_NOTARIZATION"
```

View detailed error logs:
```bash
xcrun notarytool log <submission-id> --keychain-profile "TIBOK_NOTARIZATION"
```

Common notarization failures:
- **Not signed with Developer ID**: Re-run step 1
- **Invalid entitlements**: Check `tibok/Resources/tibok-dmg.entitlements`
- **Missing hardened runtime**: Verify `--options runtime` in codesign command

## Project Structure

```
tibok/
├── tibok/                      # Main app source
│   ├── tibokApp.swift         # App entry point
│   ├── ContentView.swift      # Main window layout
│   ├── Models/                # Data models (AppState, GitModels, etc.)
│   ├── Views/                 # SwiftUI views (EditorView, GitPanelView, etc.)
│   ├── Services/              # Business logic (GitService, WorkspaceMonitor)
│   ├── Helpers/               # Helper classes (GitPanelManager for NSPanel modals)
│   ├── Extensions/            # Extension methods (KeyboardShortcuts)
│   └── Resources/             # Assets, icons, Info.plist, entitlements
├── scripts/                   # Build automation scripts
│   ├── build-app.sh          # Local development build
│   ├── build-release-dmg.sh  # Production build with signing
│   ├── create-dmg.sh         # DMG creation
│   └── notarize-dmg.sh       # Notarization wrapper script
├── user_docs/                 # End-user documentation
└── tibok.xcodeproj/          # Xcode project (generated by XcodeGen)
```

## Key Configuration Files

### Code Signing & Distribution

- **Developer ID**: F2PFRMGC9V (Kristina Quinones)
- **Bundle ID**: `com.kquinones.tibok` (DMG distribution)
- **Bundle ID**: `app.tibok.editor` (App Store distribution)
- **Entitlements (DMG)**: `tibok/Resources/tibok-dmg.entitlements`
- **Entitlements (App Store)**: `tibok/Resources/tibok-appstore.entitlements`

### Sandbox Configuration (CRITICAL)

**DMG Distribution**: Sandbox DISABLED (`com.apple.security.app-sandbox = false`)
- Required for git subprocess execution (`/usr/bin/git`)
- App sandbox blocks Process() calls to external binaries
- Hardened runtime still enabled for notarization

**App Store Distribution**: Sandbox ENABLED (`com.apple.security.app-sandbox = true`)
- Required by Mac App Store guidelines
- Uses security-scoped bookmarks for .git access
- Git operations may have limitations

**Why this matters:**
- Sandboxed apps cannot execute `/usr/bin/git` - will show "xcrun: error: cannot be used within an App Sandbox"
- DMG users expect full git functionality, so sandbox must be disabled
- App Store requires sandbox, so git features may be limited or require workarounds

### Important Build Settings

- **Deployment Target**: macOS 14.0+
- **Swift Version**: 5.9+
- **Architectures**: arm64 (Apple Silicon native)
- **Signing**: Developer ID Application (DMG) or Mac App Store (App Store)

## Development Guidelines

### Adding New Features

1. **Code Changes**: Implement feature in appropriate Models/Views/Services
2. **User Documentation**: Update `user_docs/features/*.md` if user-facing
3. **Keyboard Shortcuts**: Update `user_docs/features/keyboard-shortcuts.md`
4. **Changelog**: Update `APP_STORE_RELEASE.md` with feature description
5. **Testing**: Build and test locally before committing

### UI Patterns

#### NSPanel for Modals (Preferred)

For modals that need instant show/dismiss without animation flash, use NSPanel instead of SwiftUI sheets:

**When to use NSPanel:**
- Git operations (commit, branch, diff, history) ✅ Implemented Dec 30, 2025
- Any modal where sheet dismissal causes visual flash
- Modals that need precise control over appearance/dismissal

**Pattern** (see `GitPanelManager.swift` for reference):
```swift
@MainActor
class PanelManager: ObservableObject {
    private var panel: NSPanel?

    func showPanel(onDismiss: @escaping () -> Void) {
        dismissPanel()

        let panel = NSPanel(
            contentRect: NSRect(x: 0, y: 0, width: 400, height: 300),
            styleMask: [.titled, .closable],  // ESC key support
            backing: .buffered,
            defer: false
        )
        panel.title = "Panel Title"
        panel.isFloatingPanel = true
        panel.level = .floating
        panel.becomesKeyOnlyIfNeeded = true

        let hostingView = NSHostingView(rootView: YourSwiftUIView(onDismiss: onDismiss))
        panel.contentView = hostingView
        panel.center()

        self.panel = panel
        panel.makeKeyAndOrderFront(nil)  // Instant show
    }

    func dismissPanel() {
        panel?.close()  // Instant dismiss
        panel = nil
    }
}
```

**Key benefits:**
- `makeKeyAndOrderFront(nil)` = instant show, no animation
- `close()` = instant dismiss, zero flash
- ESC key works via `.closable` style mask
- Pattern proven in EditorView (slash menu, date picker, emoji picker)

#### Atomic State for Complex UI

When multiple state variables control a single UI interaction, use atomic state struct to prevent race conditions:

**Problem** (race condition):
```swift
@State private var selectedFile: File?
@State private var isStaged: Bool = false
@State private var showModal: Bool = false

// THREE SEPARATE UPDATES - can execute out of order!
selectedFile = file
isStaged = false
showModal = true
```

**Solution** (atomic state):
```swift
struct PresentationState: Equatable {
    let file: File
    let isStaged: Bool
}

@State private var presentationState: PresentationState?

// SINGLE ATOMIC UPDATE
presentationState = PresentationState(file: file, isStaged: false)

// onChange fires only with complete valid state
.onChange(of: presentationState) { old, new in
    if let state = new {
        showPanel(file: state.file, staged: state.isStaged)
        presentationState = nil
    }
}
```

**Implemented in:**
- `GitPanelView.swift` - DiffPresentationState (Dec 30, 2025)

#### Security-Scoped Bookmarks for Sandbox Access (App Store Only)

**Note:** This section applies ONLY to App Store builds. DMG builds have sandbox disabled and don't need security-scoped bookmarks.

For App Store compliance, the app runs in a sandbox that restricts access to hidden files like .git directories. Use security-scoped bookmarks to request persistent access to these directories.

**When to use (App Store builds only):**
- Accessing hidden directories (.git, .DS_Store, etc.)
- Reading/writing files outside user-selected directories
- Any resource that requires explicit sandbox permission

**Pattern** (see `AppState.swift:325-415` for reference):

```swift
// 1. Request access when opening resource
let hiddenURL = workspaceURL.appendingPathComponent(".git")
if FileManager.default.fileExists(atPath: hiddenURL.path) {
    let canAccess = hiddenURL.startAccessingSecurityScopedResource()

    if canAccess {
        do {
            // Create bookmark for persistent access
            let bookmarkData = try hiddenURL.bookmarkData(
                options: .withSecurityScope,
                includingResourceValuesForKeys: nil,
                relativeTo: nil
            )

            // Store bookmark in UserDefaults
            let bookmarkKey = "bookmark-\(workspaceURL.path)"
            UserDefaults.standard.set(bookmarkData, forKey: bookmarkKey)
        } catch {
            print("Failed to create bookmark: \(error)")
        }
    }
}

// 2. Restore access on app launch
if let bookmarkData = UserDefaults.standard.data(forKey: bookmarkKey) {
    do {
        var isStale = false
        let restoredURL = try URL(
            resolvingBookmarkData: bookmarkData,
            options: .withSecurityScope,
            relativeTo: nil,
            bookmarkDataIsStale: &isStale
        )

        if !isStale {
            _ = restoredURL.startAccessingSecurityScopedResource()
        } else {
            // Bookmark expired, recreate on next access
            UserDefaults.standard.removeObject(forKey: bookmarkKey)
        }
    } catch {
        print("Failed to restore bookmark: \(error)")
        UserDefaults.standard.removeObject(forKey: bookmarkKey)
    }
}

// 3. Cleanup when done
hiddenURL.stopAccessingSecurityScopedResource()
```

**Key principles:**
- `startAccessingSecurityScopedResource()` must be paired with `stopAccessingSecurityScopedResource()`
- Store bookmarks in UserDefaults for persistence across app launches
- Handle stale bookmarks gracefully (remove and recreate)
- Use unique keys for each resource (e.g., include workspace path)
- Call stop when switching resources or on app termination

**Implemented in:**
- `AppState.swift` - .git directory access (Dec 30, 2025)
- `tibokApp.swift` - cleanup on app termination (Dec 30, 2025)

**Why this matters (App Store builds only):**
- Debug builds: Sandbox relaxed, violations logged but not enforced
- App Store builds: Sandbox strict, violations block access immediately
- Without bookmarks: `.git` access denied → git detection fails
- DMG builds: Sandbox disabled, so this doesn't apply

### Xcode Project Management

The project uses **XcodeGen** to generate the `.xcodeproj` file from `project.yml`.

**IMPORTANT**: When adding new Swift files to the project:
1. Create the file in the appropriate directory (Models/Views/Services/Extensions)
2. The file must be **manually registered** in `tibok.xcodeproj/project.pbxproj`
3. **OR** regenerate the Xcode project with: `xcodegen generate --spec project.yml`

**Why manual registration is needed**: Xcode Cloud builds use the `.xcodeproj` file, not the filesystem. Files that exist on disk but aren't in the project file will cause "Cannot find ... in scope" compilation errors.

#### Adding Files to Xcode Project Manually

Each file requires 4 entries in `project.pbxproj`:
1. **PBXFileReference** - File definition with UUID
2. **PBXBuildFile** - Links file to build system
3. **PBXGroup** - Navigator placement (Models/Views/Services/Extensions)
4. **PBXSourcesBuildPhase** - Compilation inclusion

See recent fix in commit history for example of adding GitModels.swift, GitHistoryView.swift, etc.

### Git Workflow

- **Main branch**: `main` - stable releases
- **Development branch**: `development` - active development
- **App Store branch**: `apple-store-distro` - triggers Xcode Cloud builds

When implementing features:
1. Work on `development` branch
2. Merge to `main` when stable
3. Merge `main` to `apple-store-distro` for App Store releases

## Common Tasks

### Run Local Build
```bash
./scripts/build-app.sh && open .build/debug/tibok.app
```

### Run Swift Tests
```bash
swift test
```

### Check Code Signing
```bash
codesign --verify --deep --strict --verbose=2 .build/release/tibok.app
```

### View Git History
```bash
git log --oneline --graph --all -20
```

### Create GitHub Release
```bash
# After notarizing DMG
gh release create v1.0.X \
  --title "Tibok v1.0.X - Release Title" \
  --notes-file RELEASE_NOTES.md \
  .build/release/Tibok-1.0.X.dmg
```

## Documentation Files

- **APP_STORE_RELEASE.md** - Version info, changelog, release workflows
- **APP_STORE_BUILD_GUIDE.md** - Complete guide to App Store builds
- **XCODE_CLOUD_SETUP.md** - Xcode Cloud configuration
- **DEVELOPMENT.md** - General development guidelines
- **.cursorrules** - Cursor IDE specific rules
- **claude.md** (this file) - Claude Code specific instructions

## References

- App Store Connect: https://appstoreconnect.apple.com
- GitHub Repository: https://github.com/sturdy-barnacle/md-editor
- Developer Portal: https://developer.apple.com/account

## Quick Reference: Release Checklist

### For App Store Release
- [ ] Update version in Info-AppStore.plist
- [ ] Update APP_STORE_RELEASE.md changelog
- [ ] Commit and push to main
- [ ] Merge to apple-store-distro
- [ ] Monitor Xcode Cloud build
- [ ] Test on TestFlight
- [ ] Submit for review in App Store Connect

### For GitHub Release
- [ ] Update version in Info.plist
- [ ] Run build-release-dmg.sh
- [ ] Create DMG with create-dmg.sh
- [ ] **NOTARIZE with xcrun notarytool** (CRITICAL)
- [ ] **STAPLE with xcrun stapler** (CRITICAL)
- [ ] Verify with xcrun stapler validate
- [ ] Upload to GitHub release
- [ ] Test downloaded DMG on clean Mac

---

**Remember**: When in doubt about release workflows, consult APP_STORE_RELEASE.md for detailed instructions. Always notarize DMG files before public distribution.
