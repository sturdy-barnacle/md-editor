# Progress Notes - December 14, 2025

## Session: Late Night Development (approx. 12am - 2am)

### Features Implemented

#### Image Handling
- **Drag & drop support**: Images can be dragged directly into the editor
- **Paste from clipboard**: Cmd+V pastes images from clipboard
- **Automatic assets folder**: Creates `./assets/` folder next to document
- **Unique filenames**: Appends `-1`, `-2`, etc. to avoid conflicts
- **Relative paths**: Uses `![](./assets/filename.png)` for portability
- **Supported formats**: PNG, JPG, JPEG, GIF, WEBP, SVG, BMP, TIFF
- **Fallback behavior**: Uses absolute paths for unsaved documents

#### Preview Rendering Enhancements
- **Table support**: Full markdown table parsing with `<table>`, `<thead>`, `<tbody>`
- **Footnotes**: `[^ref]` references with linked footnotes section at bottom
- **Table of Contents**: `[[toc]]` generates navigable TOC from headers
- **H5/H6 headers**: Complete heading support (h1-h6) with proper CSS styling
- **Dark mode styles**: All new elements styled for both light and dark modes

#### Dark Mode Toggle
- Added to Settings > General > Appearance
- Three options: System (follows macOS), Light, Dark
- Persists across app launches via @AppStorage
- Added toggle in title bar for quick access

#### Custom Title Bar
- Replaced SwiftUI toolbar with custom title bar view
- Removed all button borders/backgrounds for cleaner appearance
- Custom `TitleBarButton` and `TitleBarMenuButton` components
- Hover effects on icons (secondary -> primary color)
- Native NSMenu for dropdown menus

#### Window Title
- Dynamic title: "tibok — filename.md"
- Updates when document changes

#### Sidebar Enhancement
- Added "Open File..." button between Workspace and Recent sections

#### Command Palette Fix
- Fixed scroll behavior when navigating to bottom items
- Changed anchor from `.center` to `nil` to prevent bounce-back
- Smooth animation on selection change

### Bug Fixes
- Fixed crash on launch: Removed `init()` that called `applyAppearance()` before NSApp was available
- Fixed toolbar button borders: Complete rewrite using custom NSView subclasses

### Documentation Updates
- Updated CHANGELOG.md with all new features
- Updated user_docs/FAQ.md:
  - Added Appearance section
  - Updated sidebar description
  - Added CSV to supported file types
- Updated user_docs/features/preview.md:
  - Added footnotes documentation
  - Added TOC documentation
  - Added callouts documentation
  - Added highlight syntax
- Updated user_docs/features/keyboard-shortcuts.md:
  - Added Command Palette section
- Updated user_docs/README.md:
  - Added command palette to quick start
  - Updated version to Beta v0.5

### Bug Fixes (continued)
- Fixed callout rendering: Callouts now render as a single cohesive block instead of separate divs with gaps
  - Added `inCallout` state tracking in MarkdownRenderer
  - Content lines wrapped in `<p>` tags inside single callout `<div>`
  - Simplified CSS - removed `.callout-content` class

### Technical Notes
- Image handling implemented in `SlashTextView` class (EditorView.swift)
- `getDocumentURL` closure passed from EditorView -> FindableTextEditor -> SlashTextView
- Custom title bar uses pure SwiftUI with NSViewRepresentable for menu triggers
- Markdown renderer now collects headers for TOC and assigns IDs for anchor links
- Callouts use state machine approach: `inCallout` flag tracks when inside a callout block

### Files Modified
- `tibok/Views/EditorView.swift` - Image drag/drop/paste
- `tibok/Views/ContentView.swift` - Custom title bar, toolbar components
- `tibok/Views/SidebarView.swift` - Open File button
- `tibok/Views/SettingsView.swift` - Appearance picker
- `tibok/Views/PreviewView.swift` - H5/H6, footnotes, TOC CSS
- `tibok/Services/MarkdownRenderer.swift` - Tables, footnotes, TOC, header IDs
- `tibok/tibokApp.swift` - Window title, appearance on launch
- `user_docs/*` - Documentation updates
- `CHANGELOG.md` - Feature changelog

---

## Session: Morning Development (approx. 12pm)

### Help Menu
- Added Help menu (⌘?) with documentation links
- Menu items:
  - **tibok Help** - Opens main README documentation
  - **Keyboard Shortcuts** - Opens keyboard shortcuts reference
  - **Slash Commands Reference** - Opens slash commands documentation
  - **Report an Issue...** - Opens GitHub issues page
- Tries multiple paths: bundle resources, development path, fallback to GitHub

### App Icon Setup
- Created `Assets.xcassets/AppIcon.appiconset/` structure
- Added `Contents.json` with all required macOS icon sizes (16, 32, 128, 256, 512 @1x and @2x)
- Updated `Package.swift` to include asset resources
- **Note**: Icon images need to be added by designer (placeholder structure ready)

### Files Modified
- `tibok/tibokApp.swift` - Help menu, openHelp(), openHelpFile() functions
- `tibok/Resources/Assets.xcassets/` - New asset catalog structure
- `Package.swift` - Added resources configuration

### Liquid Glass App Icon
- Created layered SVG assets for Icon Composer:
  - `background.svg` - Solid background layer
  - `muted-hash.svg` - Muted `#` symbol (middle layer)
  - `foreground-t.svg` - Bold `t` letter (front layer)
- Used Icon Composer to apply Liquid Glass material
- Compiled with `actool` to generate `Assets.car` and `icon.icns`
- Updated `Info.plist` with `CFBundleIconName` for Liquid Glass support
- Updated `build-app.sh` to compile `.icon` files automatically

### Files Modified (continued)
- `tibok/Resources/IconLayers/` - SVG layers and `.icon` package
- `tibok/Resources/Info.plist` - Added CFBundleIconName
- `scripts/build-app.sh` - Liquid Glass icon compilation
- `Package.swift` - Excluded IconLayers from SPM build

---

## Session: Afternoon Development

### Polish & Technical Debt

#### Title Bar Styling
- Styled title bar to match status bar appearance
- Added subtle background overlay (`Color.primary.opacity(0.03)`)
- Added bottom border (0.5pt line with `Color.primary.opacity(0.08)`)
- Changed background from `windowBackgroundColor` to `textBackgroundColor`

#### Sidebar Toggle Shortcut
- Changed sidebar toggle from `Cmd+Option+S` to `Cmd+0` (standard macOS)
- Updated menu, command palette, tooltip, and documentation

#### KaTeX Bundled Locally
- Downloaded KaTeX v0.16.9 (CSS, JS, 20 font files) to `tibok/Resources/katex/`
- Updated `PreviewView.swift` to load from bundle instead of CDN
- Updated `build-app.sh` to copy katex folder to app bundle
- Math rendering now works offline without internet connection

#### Content Search in Sidebar
- Added full-text search within workspace files
- Type 2+ characters to search file contents (not just filenames)
- Shows "Content Matches" section with:
  - Filename and line number
  - Matching line text preview
- Debounced async search for performance
- Limits: 3 matches per file, 50 total results
- Searches `.md`, `.markdown`, `.txt` files

#### Print Support
- Added `Cmd+P` print command in File menu
- Renders markdown to HTML with print styles
- Opens native macOS print dialog
- Proper page settings (Letter size, 0.75" margins)
- Added `printDocument()` function to AppState

#### Underline Slash Command
- Added `/underline` command that inserts `<u>{{CURSOR}}</u>`
- Uses HTML passthrough (no standard markdown syntax for underlines)

### Documentation Updates
- Updated `user_docs/features/keyboard-shortcuts.md`:
  - Changed sidebar toggle to `Cmd+0`
  - Added Print (`Cmd+P`)
- Updated `user_docs/features/slash-commands.md`:
  - Added h4, h5, h6 headings
  - Added bolditalic, underline, subscript, superscript
  - Added math, mathblock
  - Added definition list

### Files Modified
- `tibok/Views/ContentView.swift` - Title bar styling, sidebar shortcut
- `tibok/Views/PreviewView.swift` - Local KaTeX loading
- `tibok/Views/SidebarView.swift` - Content search functionality
- `tibok/Views/EditorView.swift` - Underline slash command
- `tibok/Models/AppState.swift` - Print support
- `tibok/tibokApp.swift` - Print menu, sidebar shortcut
- `scripts/build-app.sh` - KaTeX resource copying
- `tibok/Resources/katex/` - Bundled KaTeX files
- `user_docs/features/keyboard-shortcuts.md` - Updated shortcuts
- `user_docs/features/slash-commands.md` - Complete command reference

---

## Session: Afternoon Development (continued)

### Bug Fixes

#### Help Menu Fix
- Simplified Help menu to open GitHub URLs directly (in-app help window had issues)
- "tibok Help" → Opens GitHub README
- "Report an Issue" → Opens GitHub Issues
- Removed conflicting `⌘?` shortcut that caused window shuddering

#### Settings Page Labels
- Fixed Settings page showing localization keys instead of user-facing text
- Replaced `NSLocalizedString` calls with plain strings
- All tabs and sections now show proper labels: General, Editor, Preview, About

#### URL Updates
- Updated placeholder URLs to use `github.com/anthropics/tibok`
- Set privacy URL to `nil` until available

### Files Modified
- `tibok/tibokApp.swift` - Simplified Help menu
- `tibok/Views/SettingsView.swift` - Fixed labels, updated URLs
- `scripts/build-app.sh` - Added user_docs copying to bundle

---

## Session: Evening Development

### Multiple Open Files (Tabs)
- **Tab bar UI**: Horizontal tab bar appears when 2+ documents open
- **Tab management**: Close individual tabs (×), close others, close all
- **Keyboard shortcuts**: ⌘1-9 for direct tab access, ⌘⇧[ and ⌘⇧] for prev/next
- **Visual indicators**: Modified dot on unsaved tabs
- **Reopen closed**: ⌘⇧T reopens last closed tab (up to 10 stored)
- **Tab persistence**: Open tabs restored on app relaunch
- **Unsaved prompts**: Save/Don't Save/Cancel dialog when closing modified tabs

### Git Integration
- **GitService** (`Services/GitService.swift`): Core service executing git commands via Process
- **Status detection**: Parses `git status --porcelain` for file states
- **File indicators**: Color-coded dots in sidebar (blue=modified, green=staged, yellow=untracked, red=conflict)
- **Git panel**: Collapsible sidebar section showing staged/unstaged changes
- **Branch display**: Current branch name in status bar with change count
- **Staging operations**: Stage/unstage individual files or all changes
- **Commit**: Commit sheet via ⌘⇧K with message input
- **Push/Pull**: Full remote operations using system git credentials
- **Context menus**: Right-click Stage/Unstage/Discard on files
- **Git menu**: New menu bar item with all Git operations
- **Command palette**: All git commands accessible via ⌘K

### New Files Created
- `tibok/Views/TabBarView.swift` - Tab bar UI component
- `tibok/Services/GitService.swift` - Git command execution and parsing
- `tibok/Views/GitPanelView.swift` - Git panel with staged/unstaged lists and commit sheet

### Files Modified
- `tibok/Models/AppState.swift` - Multi-document state, tab operations, git state and methods
- `tibok/Views/ContentView.swift` - Tab bar integration, git commands in palette, commit sheet handler
- `tibok/Views/SidebarView.swift` - Git status indicators, context menu actions, GitPanelView integration
- `tibok/Views/StatusBarView.swift` - Branch name and change count display
- `tibok/tibokApp.swift` - Tab shortcuts in View menu, Git menu with all operations

### Documentation Updates
- Created `user_docs/features/git-integration.md` - Complete Git feature documentation
- Updated `user_docs/README.md` - Added Git integration link
- Updated `user_docs/features/keyboard-shortcuts.md` - Added tab and git shortcuts
- Updated `planning/roadmap.md` - Marked Tabs and Git as completed, bumped to v0.6

### Technical Notes
- Git integration uses `/usr/bin/git` directly - no GitHub API, works with any remote
- Authentication relies on existing SSH keys or credential helpers
- Status refresh uses 100ms debounce to avoid hammering git on rapid changes
- Tab state persisted to UserDefaults, restored on launch
- Closed tabs stored in memory (up to 10) for reopen functionality
